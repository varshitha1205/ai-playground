<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Playground | NextGen Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --sidebar-bg: #f8fafc;
            --accent: #6366f1;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            /* Chart Palette from Screenshot */
            --chart-orange: #e76f51;
            --chart-teal: #2a9d8f;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            width: 280px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background-color: #f1f5f9;
            color: var(--text-main);
        }

        .nav-link.active {
            background-color: #ffffff;
            color: var(--accent);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            border: 1px solid var(--border);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 32px;
            scroll-behavior: smooth;
        }

        .message-row {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .user-message {
            align-self: flex-end;
            background: #f1f5f9;
            padding: 16px 24px;
            border-radius: 20px 20px 4px 20px;
            font-size: 15px;
            max-width: 80%;
        }

        .assistant-message {
            align-self: flex-start;
            width: 100%;
        }

        .ai-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-main);
            margin-bottom: 24px;
        }

        /* The High-Fidelity Chart Card from Screenshot */
        .chart-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 700px;
            margin-top: 16px;
        }

        .input-area {
            padding: 24px 40px 40px;
            background: #ffffff;
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05);
        }

        .custom-textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 12px;
            font-size: 15px;
            resize: none;
            max-height: 200px;
            font-family: inherit;
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-muted);
        }

        .action-btn:hover {
            background: #f1f5f9;
            color: var(--text-main);
        }

        .send-btn {
            background: var(--accent);
            color: white !important;
        }

        .send-btn:hover {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .settings-grid {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .kb-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .loader-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 0.6s infinite alternate;
        }

        .loader-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            to {
                opacity: 0.3;
                transform: translateY(-4px);
            }
        }

        /* Hide code blocks from UI */
        pre {
            display: none;
        }
    </style>
</head>

<body class="flex">

    <!-- Sidebar -->
    <aside class="sidebar h-full p-6">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                <i data-lucide="layers" class="w-6 h-6"></i>
            </div>
            <span class="text-xl font-bold tracking-tight">Analytics AI</span>
        </div>

        <nav class="flex-1 space-y-1">
            <button onclick="switchTab('chat')" id="tab-chat" class="nav-link active w-full">
                <i data-lucide="message-circle" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="nav-link w-full">
                <i data-lucide="settings" class="w-5 h-5"></i> Settings
            </button>
            <button onclick="switchTab('vault')" id="tab-vault" class="nav-link w-full">
                <i data-lucide="shield" class="w-5 h-5"></i> Vault
            </button>
        </nav>

        <div class="mt-auto space-y-4">
            <button onclick="newChat()"
                class="nav-link text-indigo-600 hover:text-indigo-700 w-full justify-center border border-indigo-100 bg-indigo-50/50">
                <i data-lucide="plus" class="w-4 h-4"></i> New Analysis
            </button>
            <div class="p-4 bg-slate-100 rounded-2xl">
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                    <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Orchestrator
                        Online</span>
                </div>
                <div id="active-model-display" class="text-xs text-slate-400 truncate">GPT-4o / Groq / Gemini</div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Chat Area -->
        <div id="content-chat" class="flex-1 flex flex-col relative overflow-hidden">
            <div id="chat-messages" class="chat-container">
                <div class="assistant-message message-row">
                    <div class="ai-text">
                        <p class="font-bold text-3xl mb-4">Hello!</p>
                        <p class="text-slate-500 max-w-lg">I've been upgraded with the high-fidelity visualization
                            engine. Upload your datasets and I'll generate boardroom-ready charts instantly.</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div id="file-previews" class="max-w-[900px] mx-auto flex gap-2 mb-3 flex-wrap"></div>
                <div class="input-wrapper">
                    <label class="action-btn cursor-pointer">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                        <input type="file" id="file-upload" class="hidden" multiple onchange="handleFileUpload(event)">
                    </label>
                    <textarea id="chat-input" placeholder="Type your query..." class="custom-textarea"
                        rows="1"></textarea>
                    <button onclick="sendMessage()" class="action-btn send-btn">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Area -->
        <div id="content-settings" class="hidden flex-1 overflow-y-auto">
            <div class="settings-grid">
                <div class="space-y-10">
                    <section>
                        <h2 class="text-2xl font-bold mb-6">Core Configuration</h2>
                        <div class="form-group">
                            <label class="form-label">Persona Matrix</label>
                            <textarea id="setting-persona" class="form-input h-32"
                                placeholder="Define AI behavior..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Model</label>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <button onclick="selectProvider('groq')" id="prov-groq"
                                    class="py-2 text-xs font-bold border rounded-lg transition-all">Groq</button>
                                <button onclick="selectProvider('openai')" id="prov-openai"
                                    class="py-2 text-xs font-bold border rounded-lg transition-all">OpenAI</button>
                                <button onclick="selectProvider('gemini')" id="prov-gemini"
                                    class="py-2 text-xs font-bold border rounded-lg transition-all">Gemini</button>
                            </div>
                            <select id="setting-model" class="form-input"></select>
                        </div>
                    </section>
                </div>

                <div class="space-y-10">
                    <section class="border border-slate-200 p-8 rounded-3xl bg-slate-50/50">
                        <h2 class="text-2xl font-bold mb-6">Expert Database</h2>
                        <div class="space-y-4">
                            <div class="flex items-center gap-3 mb-6">
                                <input type="checkbox" id="db-enabled"
                                    class="w-5 h-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="font-semibold text-slate-700">Enable Neural DB Access</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">Type</label><select id="db-type" class="form-input">
                                        <option value="mysql">MySQL</option>
                                        <option value="postgresql">PostgreSQL</option>
                                        <option value="sqlite">SQLite</option>
                                    </select></div>
                                <div><label class="form-label">Host</label><input type="text" id="db-host"
                                        class="form-input"></div>
                            </div>
                            <div><label class="form-label">DB Name</label><input type="text" id="db-name"
                                    class="form-input"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">User</label><input type="text" id="db-user"
                                        class="form-input"></div>
                                <div><label class="form-label">Pass</label><input type="password" id="db-pass"
                                        class="form-input"></div>
                            </div>
                            <button onclick="testDBConnection()"
                                class="w-full py-3 bg-white border border-slate-200 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-slate-50 transition-colors">Test
                                Connection</button>
                        </div>
                    </section>

                    <section class="border border-indigo-100 p-8 rounded-3xl bg-indigo-50/30">
                        <h2 class="text-2xl font-bold mb-6">Knowledge Base</h2>
                        <label
                            class="cursor-pointer border-2 border-dashed border-indigo-200 rounded-2xl p-8 flex flex-col items-center hover:bg-indigo-50/50 transition-all">
                            <i data-lucide="upload" class="w-8 h-8 text-indigo-300 mb-2"></i>
                            <span class="text-sm font-semibold text-indigo-600">Drag & Drop Files</span>
                            <input type="file" id="kb-upload" class="hidden" multiple onchange="handleKBUpload(event)">
                        </label>
                        <div id="kb-status" class="mt-6 space-y-2"></div>
                        <button onclick="clearKB()"
                            class="text-[10px] text-slate-400 hover:text-red-500 uppercase mt-4 block mx-auto">Clear
                            Index</button>
                    </section>
                </div>
            </div>
            <div class="max-w-[1200px] border-t border-slate-100 pt-10 mt-10 text-center pb-20">
                <button onclick="saveSettings()"
                    class="bg-indigo-600 px-12 py-4 rounded-2xl text-white font-bold text-lg hover:shadow-xl hover:bg-indigo-700 transition-all">Save
                    Global Config</button>
            </div>
        </div>

        <!-- Vault Area -->
        <div id="content-vault" class="hidden flex-1 p-20">
            <div class="max-w-md mx-auto space-y-8">
                <h2 class="text-3xl font-extrabold text-center">Secret Vault</h2>
                <div class="bg-amber-50 border border-amber-100 p-4 rounded-xl text-amber-700 text-sm">
                    All keys are stored locally and encrypted in the orchestrator environment.
                </div>
                <div class="space-y-6">
                    <div class="form-group"><label class="form-label">Groq Key</label><input type="password"
                            id="key-groq" class="form-input"></div>
                    <div class="form-group"><label class="form-label">OpenAI Key</label><input type="password"
                            id="key-openai" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Gemini Key</label><input type="password"
                            id="key-gemini" class="form-input"></div>
                </div>
                <button onclick="saveKeys()"
                    class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition-colors">Secure
                    Keys</button>
            </div>
        </div>

    </main>

    <script>
        lucide.createIcons();
        let config = { api_keys: {}, persona: "You are an elite data analyst.", active_model: "llama-3.3-70b-versatile", provider: "groq", db: { enabled: false } };
        const models = { groq: ["llama-3.3-70b-versatile", "llama-3.1-8b-instant"], openai: ["gpt-4o", "gpt-4o-mini"], gemini: ["gemini-1.5-pro", "gemini-1.5-flash", "gemini-2.0-flash-exp"] };
        let chatHistory = []; let tempContextText = "";

        // Screenshot-accurate palette
        const COLORS = { orange: '#e76f51', teal: '#2a9d8f', muted: '#f1f5f9', grid: '#e2e8f0', text: '#64748b' };

        function switchTab(tab) {
            ['chat', 'settings', 'vault'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        function selectProvider(p) {
            config.provider = p;
            document.querySelectorAll('[id^="prov-"]').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600'));
            const active = document.getElementById(`prov-${p}`);
            active.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
            updateModelDropdown();
        }

        function updateModelDropdown() {
            const select = document.getElementById('setting-model'); select.innerHTML = '';
            models[config.provider].forEach(m => {
                const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select.appendChild(opt);
            });
            if (models[config.provider].includes(config.active_model)) select.value = config.active_model;
        }

        function newChat() { chatHistory = []; document.getElementById('chat-messages').innerHTML = ''; }

        async function handleFileUpload(event) {
            const files = event.target.files; const container = document.getElementById('file-previews');
            for (let file of files) {
                const formData = new FormData(); formData.append('file', file);
                const chip = document.createElement('div');
                chip.className = "px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-full text-xs font-semibold flex items-center gap-2 border border-indigo-100";
                chip.innerHTML = `<span class="animate-pulse">Analyzing</span> ${file.name}`;
                container.appendChild(chip);
                try {
                    const res = await fetch('/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (data.text) tempContextText += `\n\n[FILE: ${data.filename}]\n${data.text}`;
                    chip.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> ${file.name}`; lucide.createIcons();
                } catch (e) { chip.innerHTML = "Err"; }
            }
        }

        async function handleKBUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                const formData = new FormData(); formData.append('file', file);
                try {
                    const res = await fetch('/ingest', { method: 'POST', body: formData });
                    const data = await res.json(); if (data.task_id) trackIngestTask(data.task_id, file.name);
                } catch (e) { }
            }
        }

        function trackIngestTask(taskId, filename) {
            const statusBox = document.getElementById('kb-status');
            const item = document.createElement('div'); item.className = "kb-item text-xs font-medium";
            item.innerHTML = `<span>${filename}</span> <span id="st-${taskId}" class="text-indigo-400">0%</span>`;
            statusBox.prepend(item);
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/ingest/status/${taskId}`); const data = await res.json();
                    const label = document.getElementById(`st-${taskId}`);
                    if (data.status === 'processing') { label.textContent = `${data.progress}%`; }
                    else if (data.status === 'completed') { label.textContent = "DONE"; label.className = "text-emerald-500 font-bold"; clearInterval(interval); }
                } catch (e) { clearInterval(interval); }
            }, 1000);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input'); const msg = input.value.trim(); if (!msg) return;
            input.value = '';
            const msgRow = document.createElement('div'); msgRow.className = "message-row";
            msgRow.innerHTML = `<div class="user-message">${msg}</div>`;
            document.getElementById('chat-messages').appendChild(msgRow);

            const finalMsg = tempContextText ? `${msg}\n\n[STAGED CONTEXT]\n${tempContextText}` : msg;
            const loadingId = 'load-' + Date.now();
            const loadingBox = document.createElement('div');
            loadingBox.id = loadingId; loadingBox.className = "message-row assistant-message";
            loadingBox.innerHTML = `<div class="loader-dots mt-4"><span></span><span></span><span></span></div>`;
            document.getElementById('chat-messages').appendChild(loadingBox);

            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;

            try {
                const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: finalMsg, history: chatHistory }) });
                const data = await response.json();
                document.getElementById(loadingId).remove();
                if (data.error) alert(data.error);
                else {
                    renderAssistantResponse(data.content);
                    chatHistory.push({ role: 'user', content: msg }, { role: 'assistant', content: data.content });
                }
            } catch (e) { document.getElementById(loadingId).remove(); }
        }

        function renderAssistantResponse(content) {
            const container = document.getElementById('chat-messages');
            const row = document.createElement('div'); row.className = "message-row assistant-message";

            // Extract chart
            const chartMatch = content.match(/```CHART_DATA\n([\s\S]*?)\n```/);
            let textPart = content;
            let chartData = null;
            if (chartMatch) {
                try {
                    chartData = JSON.parse(chartMatch[1]);
                    textPart = content.replace(chartMatch[0], '').trim();
                } catch (e) { console.error("JSON Error", e); }
            }

            let html = `<div class="ai-text">${marked.parse(textPart || "Generated Analysis")}</div>`;
            if (chartData) {
                const canvasId = 'canvas-' + Date.now();
                html += `<div class="chart-card"><canvas id="${canvasId}"></canvas></div>`;
                row.innerHTML = html;
                container.appendChild(row);

                setTimeout(() => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    // Setup High-Fidelity Style based on user screenshot
                    Chart.defaults.color = COLORS.text;
                    Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";

                    const PRO_PALETTE = ['#e76f51', '#2a9d8f', '#264653', '#e9c46a', '#f4a261', '#6366f1'];
                    const isCircular = chartData.type === 'pie' || chartData.type === 'doughnut';

                    new Chart(ctx, {
                        ...chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: isCircular ? { x: { display: false }, y: { display: false } } : {
                                y: {
                                    grid: { color: COLORS.grid, drawBorder: false, borderDash: [5, 5] },
                                    ticks: {
                                        padding: 10,
                                        callback: (v) => v >= 1000000 ? '$' + (v / 1000000) + 'M' : v >= 1000 ? v / 1000 + 'K' : '$' + v
                                    }
                                },
                                x: { grid: { display: false }, ticks: { padding: 10 } }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: { usePointStyle: true, pointStyle: 'rect', padding: 25, borderRadius: 4, font: { weight: 600 } }
                                },
                                tooltip: {
                                    backgroundColor: '#1e293b',
                                    padding: 12,
                                    bodySpacing: 8,
                                    titleFont: { size: 14, weight: 700 },
                                    cornerRadius: 12,
                                    displayColors: true
                                }
                            }
                        }
                    });

                    const chartInstance = Chart.getChart(canvasId);
                    chartInstance.data.datasets.forEach((ds, idx) => {
                        if (isCircular && (!ds.backgroundColor || ds.backgroundColor.length < 2)) {
                            ds.backgroundColor = PRO_PALETTE;
                        } else if (!ds.backgroundColor) {
                            ds.backgroundColor = idx === 0 ? COLORS.orange : idx === 1 ? COLORS.teal : PRO_PALETTE[idx % PRO_PALETTE.length];
                        }
                        ds.borderRadius = isCircular ? 0 : 6;
                        if (!isCircular) ds.barThickness = 45;
                    });
                    chartInstance.update();
                }, 100);
            } else {
                row.innerHTML = html;
                container.appendChild(row);
            }
            container.scrollTop = container.scrollHeight;
        }

        async function loadConfig() {
            const res = await fetch('/config'); config = await res.json();
            document.getElementById('setting-persona').value = config.persona;
            ['groq', 'openai', 'gemini'].forEach(k => document.getElementById(`key-${k}`).value = config.api_keys[k] || '');
            document.getElementById('db-enabled').checked = config.db.enabled;
            ['type', 'host', 'port', 'name', 'user', 'pass'].forEach(k => document.getElementById(`db-${k}`).value = config.db[k === 'name' ? 'dbname' : k === 'pass' ? 'password' : k] || '');
            selectProvider(config.provider);
            document.getElementById('active-model-display').textContent = config.active_model.toUpperCase();
        }

        async function saveSettings() {
            config.persona = document.getElementById('setting-persona').value; config.active_model = document.getElementById('setting-model').value;
            config.db = { enabled: document.getElementById('db-enabled').checked, type: document.getElementById('db-type').value, host: document.getElementById('db-host').value, port: document.getElementById('db-port').value, dbname: document.getElementById('db-name').value, user: document.getElementById('db-user').value, password: document.getElementById('db-pass').value };
            await fetch('/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config) }); alert('Configuration Node Synced!');
        }

        async function saveKeys() {
            ['groq', 'openai', 'gemini'].forEach(k => config.api_keys[k] = document.getElementById(`key-${k}`).value);
            await fetch('/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config) }); alert('Keys Saved!');
        }

        loadConfig();
        document.getElementById('chat-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    </script>
</body>

</html>